<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusNest - Cal Poly Pomona Listings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f8ff;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #34495e;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .filters input, .filters select, .filters button {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #3498db;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    .listing {
      background: white;
      padding: 20px;
      margin: 15px auto;
      max-width: 700px;
      border-radius: 10px;
      border-left: 5px solid #3498db;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .listing h2 {
      margin-top: 0;
    }
    .favorite-btn {
      float: right;
      font-size: 20px;
      color: #e74c3c;
      cursor: pointer;
    }
    .status-tag {
      background: #eee;
      display: inline-block;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 13px;
      margin-top: 5px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      max-width: 600px;
      border-radius: 10px;
      overflow-y: auto;
      max-height: 90vh;
    }
    .close-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      float: right;
    }
    .favorites-toggle {
      display: block;
      text-align: center;
      margin: 15px 0;
    }
    .favorites-toggle a {
      display: inline-block;
      margin-top: 10px;
      background-color: #2ecc71;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
    }
    .favorites-toggle a:hover {
      background-color: #27ae60;
    }
  </style>
</head>
<body>
  <h1>CampusNest Listings (Cal Poly Pomona)</h1>

  <div class="filters">
    <input type="number" id="maxRent" placeholder="Max Rent ($)">
    <input type="text" id="roomType" placeholder="Room Type (e.g., Private)">
    <input type="number" step="0.1" id="maxDistance" placeholder="Max Distance (miles)">
    <input type="text" id="amenities" placeholder="Amenities (comma-separated)">
    <select id="sortBy">
      <option value="">Sort By</option>
      <option value="rent">Rent (Low to High)</option>
      <option value="distance">Distance (Nearest First)</option>
      <option value="roomType">Room Type (A-Z)</option>
    </select>
    <button onclick="loadListings()">Search</button>
    <button onclick="resetFilters()">Reset</button>
  </div>

  <div class="favorites-toggle">
    <button onclick="toggleFavorites()">‚ù§Ô∏è View My Saved Listings</button>
    <br><br>
    <a href="status.html">üìã View My Applications</a>
  </div>

  <div id="listings">Use the filters above to search for listings.</div>

  <!-- Modal for details -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Close</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    let showFavorites = false;
    let allListings = [];

    function loadListings() {
      showFavorites = false;
      let url = '/api/listings?';
      const maxRent = document.getElementById('maxRent').value;
      const roomType = document.getElementById('roomType').value;
      const maxDistance = document.getElementById('maxDistance').value;
      const amenities = document.getElementById('amenities').value;

      if (maxRent) url += `maxRent=${maxRent}&`;
      if (roomType) url += `roomType=${roomType}&`;
      if (maxDistance) url += `maxDistance=${maxDistance}&`;
      if (amenities) url += `amenities=${encodeURIComponent(amenities)}&`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          allListings = data;
          applySort();
        });
    }

    function applySort() {
      const sortBy = document.getElementById('sortBy').value;
      if (sortBy === 'rent') allListings.sort((a, b) => a.rent - b.rent);
      if (sortBy === 'distance') allListings.sort((a, b) => a.distance - b.distance);
      if (sortBy === 'roomType') allListings.sort((a, b) => a.roomType.localeCompare(b.roomType));
      displayListings(allListings);
    }

    function displayListings(listings) {
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const statusMap = JSON.parse(localStorage.getItem('statuses') || '{}');
      const container = document.getElementById('listings');
      container.innerHTML = '';

      if (showFavorites) {
        listings = listings.filter(l => favorites.includes(l.id));
      }

      if (listings.length === 0) {
        container.innerHTML = '<p style="text-align:center">No listings found.</p>';
        return;
      }

      listings.forEach(listing => {
        const div = document.createElement('div');
        div.className = 'listing';
        const isFav = favorites.includes(listing.id);
        const status = statusMap[listing.id] || '';
        div.innerHTML = `
          <span class="favorite-btn" onclick="toggleFavorite(${listing.id}, event)">
            ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
          </span>
          <h2>${listing.title}</h2>
          <p><strong>Rent:</strong> $${listing.rent}</p>
          <p><strong>Room Type:</strong> ${listing.roomType}</p>
          <p><strong>Distance:</strong> ${listing.distance} miles</p>
          <p><strong>Verified:</strong> ${listing.verified ? '‚úîÔ∏è' : '‚ùå'}</p>
          ${status ? `<p class="status-tag">Status: ${status}</p>` : ''}
        `;
        div.onclick = () => showDetails(listing);
        container.appendChild(div);
      });
    }

    function toggleFavorite(id, event) {
      event.stopPropagation();
      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      if (favorites.includes(id)) {
        favorites = favorites.filter(f => f !== id);
      } else {
        favorites.push(id);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      displayListings(allListings);
    }

    function toggleFavorites() {
      showFavorites = !showFavorites;
      displayListings(allListings);
    }

    function showDetails(listing) {
      const modal = document.getElementById('detailModal');
      const modalContent = document.getElementById('modalContent');
      const mapURL = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(listing.address)}`;
      const statusMap = JSON.parse(localStorage.getItem('statuses') || '{}');
      const currentStatus = statusMap[listing.id] || "";

      modalContent.innerHTML = `
        <h3>${listing.title}</h3>
        <p><strong>Address:</strong> ${listing.address} (<a href="${mapURL}" target="_blank">View on Map</a>)</p>
        <p><strong>Neighborhood:</strong> ${listing.neighborhood}</p>
        <p><strong>Rent:</strong> $${listing.rent}</p>
        <p><strong>Room Type:</strong> ${listing.roomType}</p>
        <p><strong>Distance:</strong> ${listing.distance} miles</p>
        <p><strong>Amenities:</strong> ${listing.amenities.join(', ')}</p>
        <p><strong>Verified:</strong> ${listing.verified ? '‚úîÔ∏è' : '‚ùå'}</p>
        <hr>
        <label for="statusSelect"><strong>Application Status:</strong></label>
        <select id="statusSelect" onchange="saveStatus(${listing.id})">
          <option value="">-- Select Status --</option>
          <option value="Interested" ${currentStatus==="Interested" ? "selected" : ""}>Interested</option>
          <option value="Applied" ${currentStatus==="Applied" ? "selected" : ""}>Applied</option>
          <option value="Scheduled Tour" ${currentStatus==="Scheduled Tour" ? "selected" : ""}>Scheduled Tour</option>
          <option value="Leased" ${currentStatus==="Leased" ? "selected" : ""}>Leased</option>
          <option value="Rejected" ${currentStatus==="Rejected" ? "selected" : ""}>Rejected</option>
        </select>
        <hr>
        <h4>Reviews:</h4>
        ${listing.reviews.map(r => `<p><strong>${r.user}</strong> (${r.rating}‚òÖ): ${r.comment}</p>`).join('')}
      `;
      modal.style.display = 'flex';
    }

    function saveStatus(id) {
      const selected = document.getElementById('statusSelect').value;
      const statusMap = JSON.parse(localStorage.getItem('statuses') || '{}');
      statusMap[id] = selected;
      localStorage.setItem('statuses', JSON.stringify(statusMap));
      displayListings(allListings);
    }

    function closeModal() {
      document.getElementById('detailModal').style.display = 'none';
    }

    function resetFilters() {
      document.getElementById('maxRent').value = '';
      document.getElementById('roomType').value = '';
      document.getElementById('maxDistance').value = '';
      document.getElementById('amenities').value = '';
      document.getElementById('sortBy').value = '';
      loadListings();
    }

    window.onload = loadListings;
  </script>
</body>
</html>
